<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Philip Di Fiore</title>
<link rel="stylesheet" href="https://use.typekit.net/ayz4ezz.css" />
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
</head>
<body>
<div id="root"></div>

<style>
:root {
  --bg: #fff;
  --text: #000;
  --text-dim: #999;
  --border: #000;
  --font-display: 'itc-avant-garde-gothic-pro', 'Century Gothic', sans-serif;
  --font-body: 'DM Sans', system-ui, sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: #fff;
  color: #000;
  font-family: var(--font-body);
}

.site-wrap {
  min-height: 100vh;
  background: #fff;
  display: flex;
  flex-direction: column;
}

/* Header */
.site-header {
  padding: 4rem 3rem 3rem;
  text-align: center;
  background: #fff;
  border-bottom: 1px solid #000;
}

.site-header.landing {
  padding: 6rem 3rem 4rem;
  border-bottom: none;
}

.site-title {
  font-family: var(--font-display);
  font-size: 5.5rem;
  font-weight: 800;
  color: #000;
  letter-spacing: -0.06em;
  text-transform: uppercase;
  line-height: 0.9;
  display: block;
  cursor: pointer;
}

.site-subtitle {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: #999;
  text-transform: none;
  letter-spacing: 0.02em;
  margin-top: 1.5rem;
  display: block;
  font-style: italic;
}

/* Navigation Tabs */
.tab-nav {
  display: flex;
  justify-content: center;
  gap: 0;
  padding: 0;
  border-bottom: 1px solid #000;
  background: #fff;
}

.tab-btn {
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 400;
  letter-spacing: 0;
  text-transform: none;
  padding: 1rem 2.5rem;
  border: none;
  border-right: 1px solid #000;
  background: #fff;
  color: #999;
  cursor: pointer;
  transition: all 0.15s;
}

.tab-btn:last-child { border-right: none; }

.tab-btn:hover { color: #000; }

.tab-btn.active {
  color: #000;
  font-weight: 600;
}

/* Content Area */
.content {
  max-width: 1100px;
  margin: 0 auto;
  padding: 4rem 3rem;
  flex: 1;
  width: 100%;
}

.content.landing {
  padding: 2rem 3rem 4rem;
}

/* AI Chat Section */
.chat-section {
  max-width: 700px;
  margin: 0 auto;
}

.chat-label {
  font-family: var(--font-mono);
  font-size: 0.75rem;
  color: #999;
  text-transform: none;
  letter-spacing: 0.02em;
  margin-bottom: 1.5rem;
  text-align: center;
  font-style: italic;
}

.chat-area {
  background: #fff;
  border: 1px solid #000;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 400px;
  max-height: 500px;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  background: #fff;
}

.msg {
  max-width: 85%;
  padding: 0;
  font-size: 0.95rem;
  line-height: 1.7;
}

.msg.user {
  align-self: flex-end;
  background: none;
  color: #000;
  font-weight: 400;
  text-align: right;
  border-bottom: 1px solid #000;
  padding-bottom: 1rem;
}

.msg.assistant {
  align-self: flex-start;
  background: none;
  font-style: normal;
  color: #333;
}

.chat-input-row {
  padding: 0;
  border-top: 1px solid #000;
  display: flex;
  gap: 0;
}

.chat-input {
  flex: 1;
  background: #fff;
  border: none;
  padding: 1.2rem 1.5rem;
  color: #000;
  font-family: var(--font-body);
  font-size: 0.9rem;
  outline: none;
}

.chat-input::placeholder { color: #ccc; }

.send-btn {
  background: #000;
  border: none;
  border-left: 1px solid #000;
  padding: 1.2rem 2rem;
  color: #fff;
  font-family: var(--font-body);
  font-size: 0.85rem;
  font-weight: 400;
  cursor: pointer;
  transition: all 0.15s;
}
.send-btn:hover { background: #333; }
.send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

/* Preset Question Chips */
.preset-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 0;
  margin-top: 1.5rem;
  border: 1px solid #000;
}

.chip {
  background: #fff;
  border: none;
  border-right: 1px solid #000;
  border-bottom: 1px solid #000;
  padding: 0.8rem 1.2rem;
  font-size: 0.8rem;
  color: #666;
  cursor: pointer;
  transition: all 0.15s;
  font-family: var(--font-body);
  text-align: left;
  flex: 1 1 auto;
  min-width: 45%;
}

.chip:nth-child(2n) { border-right: none; }
.chip:nth-last-child(-n+2) { border-bottom: none; }
.chip:hover { background: #000; color: #fff; }

/* Loading dots */
.dots {
  display: inline-flex;
  gap: 6px;
  align-items: center;
  padding: 0.5rem 0;
}

.dots span {
  width: 4px;
  height: 4px;
  background: #000;
  border-radius: 50%;
  animation: pulse 1.2s infinite;
}

.dots span:nth-child(2) { animation-delay: 0.2s; }
.dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes pulse {
  0%, 80%, 100% { opacity: 0.15; }
  40% { opacity: 1; }
}

/* Project Grid */
.project-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0;
  border: 1px solid #000;
}

.project-card {
  background: #fff;
  border-right: 1px solid #000;
  border-bottom: 1px solid #000;
  padding: 2rem 1.5rem;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  text-decoration: none;
  color: inherit;
  display: block;
  min-height: 140px;
}

.project-card:nth-child(3n) { border-right: none; }

.project-card:hover {
  background: #000;
  color: #fff;
}

.project-card:hover .project-subtitle { color: #666; }

.project-card .project-title {
  font-family: var(--font-display);
  font-size: 1.15rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: -0.02em;
  margin-bottom: 0.5rem;
  line-height: 1.1;
}

.project-card .project-subtitle {
  font-family: var(--font-body);
  font-size: 0.8rem;
  color: #999;
  letter-spacing: 0;
  font-weight: 400;
  font-style: italic;
}

/* Hover Image Preview */
.hover-image {
  position: fixed;
  pointer-events: none;
  z-index: 1000;
  width: 300px;
  height: auto;
  max-height: 400px;
  object-fit: cover;
  border: 1px solid #000;
  opacity: 0;
  transition: opacity 0.15s ease;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.hover-image.visible {
  opacity: 1;
}

/* About Page */
.about-content {
  max-width: 700px;
  margin: 0 auto;
}

.about-content p {
  font-size: 1.1rem;
  line-height: 1.8;
  margin-bottom: 1.5rem;
  color: #333;
}

/* Apps Page */
.apps-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0;
  border: 1px solid #000;
}

.app-card {
  background: #fff;
  border-right: 1px solid #000;
  border-bottom: 1px solid #000;
  padding: 0;
  text-decoration: none;
  color: inherit;
  display: block;
  transition: all 0.15s;
}

.app-card:nth-child(2n) { border-right: none; }
.app-card:nth-last-child(-n+2) { border-bottom: none; }

.app-card:hover { background: #fafafa; }

.app-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-bottom: 1px solid #000;
  background: #f5f5f5;
}

.app-card-content {
  padding: 1.5rem;
}

.app-card .app-title {
  font-family: var(--font-display);
  font-size: 1.2rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: -0.02em;
  margin-bottom: 0.5rem;
}

.app-card .app-desc {
  font-size: 0.85rem;
  color: #666;
  line-height: 1.6;
}

/* Detail Page */
.detail-page {
  max-width: 900px;
  margin: 0 auto;
}

.detail-back {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-family: var(--font-body);
  font-size: 0.85rem;
  color: #999;
  text-decoration: none;
  margin-bottom: 2rem;
  cursor: pointer;
  transition: color 0.15s;
}

.detail-back:hover { color: #000; }

.video-container {
  position: relative;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  border: 1px solid #000;
  margin-bottom: 2rem;
}

.video-container iframe {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

.detail-title {
  font-family: var(--font-display);
  font-size: 2rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: -0.03em;
  margin-bottom: 1rem;
}

.detail-caption {
  font-size: 1rem;
  line-height: 1.7;
  color: #444;
}

.detail-caption a { color: #000; }

/* Footer */
.site-footer {
  text-align: center;
  padding: 3rem;
  border-top: 1px solid #000;
  background: #fff;
}

.footer-contact {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2rem;
  margin-bottom: 1.5rem;
}

.footer-contact a {
  color: #000;
  text-decoration: none;
  font-size: 0.9rem;
  transition: color 0.15s;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.footer-contact a:hover { color: #666; }

.footer-contact svg {
  width: 20px;
  height: 20px;
}

.footer-copyright {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: #999;
}

/* Responsive */
@media (max-width: 900px) {
  .project-grid { grid-template-columns: repeat(2, 1fr); }
  .project-card:nth-child(3n) { border-right: 1px solid #000; }
  .project-card:nth-child(2n) { border-right: none; }
  .apps-grid { grid-template-columns: 1fr; }
  .app-card { border-right: none !important; }
}

@media (max-width: 600px) {
  .site-header { padding: 3rem 1.5rem 2rem; }
  .site-header.landing { padding: 4rem 1.5rem 2rem; }
  .site-title { font-size: 2.8rem; }
  .project-grid { grid-template-columns: 1fr; }
  .project-card { border-right: none !important; }
  .content { padding: 2rem 1.5rem; }
  .tab-btn { padding: 0.8rem 1.2rem; font-size: 0.8rem; }
  .tab-nav { flex-wrap: wrap; }
  .hover-image { display: none; }
  .detail-title { font-size: 1.5rem; }
  .chip { min-width: 100%; border-right: none !important; }
  .chat-area { min-height: 350px; }
}

/* Touch device fixes */
@media (hover: none) {
  .project-card:hover { background: #fff; color: #000; }
  .project-card:hover .project-subtitle { color: #999; }
  .project-card:active { background: #000; color: #fff; }
  .project-card:active .project-subtitle { color: #666; }
  .hover-image { display: none; }
}
</style>

<script>
// ==================== CONFIGURATION ====================

const WP_API = 'https://philipdifiore.com/wp-json/wp/v2';
const SUPABASE_URL = 'https://gjvvbofpkxuicrpshxun.supabase.co';
const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/artificial-philip`;

// Categories to merge into Films/Videos
const FILMS_VIDEOS_CATEGORIES = ['Films', 'Music Videos', 'Live'];

// Preset questions for the chat
const PRESET_QUESTIONS = [
  "Tell me about yourself",
  "Tell me about your films and videos",
  "Who/What are your influences?",
  "What are you interested in?",
  "You make apps too?"
];

// Apps data
const APPS = [
  {
    id: 'wolves',
    title: 'Wolves in the Piano',
    desc: 'Chat with 94 creative masters about their process. Features AI conversations with artists, writers, and filmmakers.',
    image: 'https://images.unsplash.com/photo-1507838153414-b4b713384a76?w=600&h=400&fit=crop',
    url: 'https://wolvesinthepiano.com'
  },
  {
    id: 'ideamachine',
    title: 'Idea Machine',
    desc: 'Capture ideas and build them into reality. A tool for developing creative concepts.',
    image: 'https://images.unsplash.com/photo-1455849318743-b2233052fcff?w=600&h=400&fit=crop',
    url: 'https://ideamachineapp.com'
  },
  {
    id: 'plotter',
    title: 'Plotter',
    desc: 'Your story builder. A tool designed to assist in creating narratives and stories.',
    image: 'https://images.unsplash.com/photo-1456324504439-367cee3b3c32?w=600&h=400&fit=crop',
    url: 'https://goplotter.com'
  },
  {
    id: 'superzero',
    title: 'Super Zero',
    desc: 'Smart note-taking with natural language parsing, kanban boards, and calendar integration.',
    image: 'https://images.unsplash.com/photo-1484480974693-6ca0a78fb36b?w=600&h=400&fit=crop',
    url: 'https://superzeroapp.com'
  }
];

// About content
const ABOUT_TEXT = `
<p>Philip Di Fiore is an award-winning director, filmmaker, and photographer based in New York.</p>
<p>His documentary <em>The Buffalo Hunt</em> won Best Feature Documentary at the Prague Film Awards and Best Director at the Milan International Film Festival. The New York Times hailed the film as "a striking, poetic look at the Lakota Sioux."</p>
<p>His documentary <em>Stranger: Bernie Worrell on Earth</em> premiered at Slamdance and features David Byrne, George Clinton, and Yasiin Bey. A 35mm print is part of The Academy of Motion Picture Arts and Sciences permanent collection.</p>
<p>His music videos have drawn comparisons to David Lynch, Alfred Hitchcock, and Martin Scorsese. He has directed commercial content for Ralph Lauren, JetBlue, Mattel, Spotify, and major record labels.</p>
`;

// Contact info
const CONTACT = {
  email: 'phil@philipdifiore.com',
  instagram: 'https://instagram.com/philipdifiore'
};

// ==================== STATE ====================

let categories = [];
let posts = [];
let currentView = 'home'; // 'home', 'films', 'about', 'apps', 'detail'
let currentPost = null;
let chatMessages = [];
let chatLoading = false;

const root = document.getElementById('root');

// ==================== API FUNCTIONS ====================

async function fetchCategories() {
  const res = await fetch(`${WP_API}/categories?per_page=100`);
  return res.json();
}

async function fetchPosts() {
  const res = await fetch(`${WP_API}/posts?_embed&per_page=100`);
  return res.json();
}

async function sendChatMessage(userMessage) {
  chatMessages.push({ role: 'user', content: userMessage });
  chatLoading = true;
  render();

  try {
    const response = await fetch(EDGE_FUNCTION_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: chatMessages })
    });

    const data = await response.json();

    if (data.error) {
      throw new Error(data.error);
    }

    chatMessages.push({ role: 'assistant', content: data.response });
  } catch (error) {
    console.error('Chat error:', error);
    chatMessages.push({
      role: 'assistant',
      content: "Sorry, I'm having trouble connecting right now. Please try again in a moment."
    });
  }

  chatLoading = false;
  render();

  // Scroll to bottom of chat
  setTimeout(() => {
    const chatBox = document.querySelector('.chat-messages');
    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
  }, 50);
}

// ==================== HELPER FUNCTIONS ====================

function getFeaturedImage(post, size = 'medium') {
  try {
    const media = post._embedded?.['wp:featuredmedia']?.[0];
    if (media) {
      return media.media_details?.sizes?.[size]?.source_url
        || media.media_details?.sizes?.medium_large?.source_url
        || media.source_url;
    }
  } catch (e) {}
  return null;
}

function getCategoryName(post) {
  try {
    return post._embedded?.['wp:term']?.[0]?.[0]?.name || '';
  } catch (e) {
    return '';
  }
}

function getVimeoId(post) {
  const content = post.content?.rendered || '';
  const match = content.match(/vimeo\.com\/(\d+)/);
  return match ? match[1] : null;
}

function getCaption(post) {
  let content = post.content?.rendered || '';
  content = content.replace(/\[[\w_]+[^\]]*\]/g, '');
  content = content.replace(/\[\/[\w_]+\]/g, '');
  content = content.replace(/<p>https?:\/\/vimeo\.com\/\d+<\/p>/g, '');
  content = content.replace(/<p>\s*<\/p>/g, '');
  content = content.replace(/<p>&nbsp;<\/p>/g, '');
  return content.trim();
}

function decodeHTML(html) {
  const txt = document.createElement('textarea');
  txt.innerHTML = html;
  return txt.value;
}

function getFilmsVideosPosts() {
  const filmCategoryIds = categories
    .filter(cat => FILMS_VIDEOS_CATEGORIES.includes(cat.name))
    .map(cat => cat.id);
  return posts.filter(post =>
    post.categories.some(catId => filmCategoryIds.includes(catId))
  );
}

// ==================== RENDER FUNCTIONS ====================

function render() {
  let content = '';
  let headerClass = '';
  let contentClass = '';

  switch (currentView) {
    case 'home':
      content = renderHome();
      headerClass = 'landing';
      contentClass = 'landing';
      break;
    case 'about':
      content = renderAbout();
      break;
    case 'apps':
      content = renderApps();
      break;
    case 'detail':
      content = renderDetail();
      break;
    case 'films':
    default:
      content = renderFilms();
  }

  root.innerHTML = `
    <div class="site-wrap">
      <header class="site-header ${headerClass}">
        <h1 class="site-title" onclick="navigateTo('home')">Philip Di Fiore</h1>
        <span class="site-subtitle">director 路 filmmaker 路 photographer</span>
      </header>

      <nav class="tab-nav">
        <button class="tab-btn ${currentView === 'home' ? 'active' : ''}" onclick="navigateTo('home')">Home</button>
        <button class="tab-btn ${currentView === 'films' || currentView === 'detail' ? 'active' : ''}" onclick="navigateTo('films')">Films/Videos</button>
        <button class="tab-btn ${currentView === 'about' ? 'active' : ''}" onclick="navigateTo('about')">About</button>
        <button class="tab-btn ${currentView === 'apps' ? 'active' : ''}" onclick="navigateTo('apps')">Apps</button>
      </nav>

      <main class="content ${contentClass}">
        ${content}
      </main>

      <footer class="site-footer">
        <div class="footer-contact">
          <a href="${CONTACT.instagram}" target="_blank">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
          </a>
          <a href="mailto:${CONTACT.email}">${CONTACT.email}</a>
        </div>
        <div class="footer-copyright">&copy; ${new Date().getFullYear()} Philip Di Fiore</div>
      </footer>
    </div>

    <img class="hover-image" src="" alt="" />
  `;

  // Attach event listeners
  if (currentView === 'home') {
    attachChatListeners();
  } else if (currentView === 'films') {
    attachFilmsListeners();
  }
}

function renderHome() {
  return `
    <div class="chat-section">
      <div class="chat-label">Chat with Artificial Philip</div>

      <div class="chat-area">
        <div class="chat-messages">
          ${chatMessages.length === 0 ? `
            <div class="msg assistant">Hey! I'm an AI version of Philip. Ask me anything about my films, creative process, apps, or influences. What would you like to know?</div>
          ` : ''}
          ${chatMessages.map(msg => `
            <div class="msg ${msg.role}">${msg.content}</div>
          `).join('')}
          ${chatLoading ? `
            <div class="msg assistant"><div class="dots"><span></span><span></span><span></span></div></div>
          ` : ''}
        </div>
        <div class="chat-input-row">
          <input type="text" class="chat-input" placeholder="Ask me anything..." id="chatInput" />
          <button class="send-btn" id="sendBtn" ${chatLoading ? 'disabled' : ''}>Send</button>
        </div>
      </div>

      <div class="preset-chips">
        ${PRESET_QUESTIONS.map(q => `
          <button class="chip" onclick="askPreset('${q}')">${q}</button>
        `).join('')}
      </div>
    </div>
  `;
}

function renderFilms() {
  const filmsPosts = getFilmsVideosPosts();

  if (filmsPosts.length === 0) {
    return `<div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>`;
  }

  return `
    <div class="project-grid">
      ${filmsPosts.map(post => {
        const imageUrl = getFeaturedImage(post, 'medium_large');
        const categoryName = getCategoryName(post);
        return `
          <div class="project-card" data-post-id="${post.id}" data-image="${imageUrl || ''}">
            <div class="project-title">${decodeHTML(post.title.rendered)}</div>
            <div class="project-subtitle">${categoryName}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function renderAbout() {
  return `<div class="about-content">${ABOUT_TEXT}</div>`;
}

function renderApps() {
  return `
    <div class="apps-grid">
      ${APPS.map(app => `
        <a href="${app.url}" target="_blank" class="app-card">
          <img src="${app.image}" alt="${app.title}" />
          <div class="app-card-content">
            <div class="app-title">${app.title}</div>
            <div class="app-desc">${app.desc}</div>
          </div>
        </a>
      `).join('')}
    </div>
  `;
}

function renderDetail() {
  if (!currentPost) return '<p>Post not found.</p>';

  const vimeoId = getVimeoId(currentPost);
  const caption = getCaption(currentPost);

  return `
    <div class="detail-page">
      <div class="detail-back" onclick="navigateTo('films')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back
      </div>

      ${vimeoId ? `
        <div class="video-container">
          <iframe src="https://player.vimeo.com/video/${vimeoId}?title=0&byline=0&portrait=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
        </div>
      ` : ''}

      <h1 class="detail-title">${decodeHTML(currentPost.title.rendered)}</h1>
      ${caption ? `<div class="detail-caption">${caption}</div>` : ''}
    </div>
  `;
}

// ==================== EVENT LISTENERS ====================

function attachChatListeners() {
  const input = document.getElementById('chatInput');
  const sendBtn = document.getElementById('sendBtn');

  if (input && sendBtn) {
    sendBtn.addEventListener('click', () => {
      const msg = input.value.trim();
      if (msg && !chatLoading) {
        sendChatMessage(msg);
        input.value = '';
      }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const msg = input.value.trim();
        if (msg && !chatLoading) {
          sendChatMessage(msg);
          input.value = '';
        }
      }
    });
  }

  // Scroll to bottom of chat
  const chatBox = document.querySelector('.chat-messages');
  if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
}

function attachFilmsListeners() {
  const hoverImage = document.querySelector('.hover-image');

  document.querySelectorAll('.project-card').forEach(card => {
    const postId = parseInt(card.dataset.postId);
    const imageUrl = card.dataset.image;

    card.addEventListener('click', () => {
      currentPost = posts.find(p => p.id === postId);
      currentView = 'detail';
      render();
      window.scrollTo(0, 0);
    });

    if (imageUrl) {
      card.addEventListener('mouseenter', () => {
        hoverImage.src = imageUrl;
        hoverImage.classList.add('visible');
      });

      card.addEventListener('mousemove', (e) => {
        const x = e.clientX;
        const y = e.clientY;
        let left = x + 20;
        if (left + 320 > window.innerWidth) left = x - 320;
        let top = y - 100;
        if (top < 10) top = 10;
        if (top + 400 > window.innerHeight) top = window.innerHeight - 410;
        hoverImage.style.left = left + 'px';
        hoverImage.style.top = top + 'px';
      });

      card.addEventListener('mouseleave', () => {
        hoverImage.classList.remove('visible');
      });
    }
  });
}

// ==================== NAVIGATION ====================

function navigateTo(view) {
  currentView = view;
  currentPost = null;
  render();
  window.scrollTo(0, 0);
}

function askPreset(question) {
  if (!chatLoading) {
    sendChatMessage(question);
  }
}

window.navigateTo = navigateTo;
window.askPreset = askPreset;

// ==================== INITIALIZE ====================

async function init() {
  root.innerHTML = `
    <div class="site-wrap">
      <header class="site-header landing">
        <h1 class="site-title">Philip Di Fiore</h1>
        <span class="site-subtitle">director 路 filmmaker 路 photographer</span>
      </header>
      <main class="content">
        <div class="loading"><div class="dots"><span></span><span></span><span></span></div></div>
      </main>
    </div>
  `;

  try {
    [categories, posts] = await Promise.all([
      fetchCategories(),
      fetchPosts()
    ]);
    render();
  } catch (error) {
    console.error('Failed to load data:', error);
    // Still render the page - chat can work without WordPress data
    render();
  }
}

init();
</script>

</body>
</html>
